# Experiment "I/O Utilization"

# Overview
The aim of this experiment is assessing how the number of threads affect the I/O utilization of different applications in different stages of their execution.

# Tools
The `iostat` command line tool was used to measure the utilization of the underlying disk. The following flags were used:
`iostat -c -d -t -x -y 1`

# Scripts

#### `buffer.awk`
The output of `iostat` command is first piped to this `awk` script and then it is piped to the `parse-iostat-output.py`. The reason for this intermediate parsing is because `iostat` outputs its result each second in several lines. Since we want to parse the output each second, we need to make sure those lines are concatenated in a single string and then piped to the next script. This is what `buffer.awk` does. Note that the variable `threshold` inside the script represents the number of lines which `iostat` produces each second (7 in our case). If the number of lines is different in your setup, this variable should be changed accordingly.

=================================================================

#### `parse-iostat-output.py`
parses the output of `iostat` on each node in real-time, filters the relevant information and outputs a comma delimited csv string each second. It opens a socket connection (`127.0.0.1:12005`) to which the spark executor connects and notify the script when a stage has changed. This script is initiated by the Spark executor once it launches.

#### Arguments
* --appName, -a: Name of the application
* --fileNameWithoutExtension, -f: Name of the output file without an extension. Note that each node produces its own separate file.
* --deviceId, -d: name of the device that needs to be monitored (e.g., `sda`). You can repeat this argument for monitoring multiple devices, in which case they will be accumulated. For instance: `-d sda -d sdb` (This is useful for any RAID setup).

#### Output
 The resulting file will be located in "`RESULT_HOME`/`nodeId`#`fileNameWithoutExtension`.iostat"

 `nodeId` is the name of the node on which the script is running.

=================================================================

#### `../iostat/parse-iostat-result.py`
TODO:

=================================================================

#### `plot_io_util.py`
plots the final figure, based on the data file generated by  `parse-iostat-output.py` script.

#### Arguments
* --inputFile, -i: Absolute path of the file generated by the `parse-iostat-output.py` script.
* --outputFile, -o: Absolute path of the directory where output files will be saved. The file name is formatted in the form of `appName`\_`stageNumber.pdf`. For example, 'terasort_s0' means the first stage of Terasort application.


# Requirements
* Before every read and right, one should make sure the OS buffer cache is cleared, so that all the I/O requests actually reach the disk rather than memory. This is done in lines 27 and 36 in `run.sh`. Since this operation requires sudo access, the user must replace this line with their own script which flushes the buffer cache.

* The `parse-iostat-output.py` script produces its logs under `$LOG_HOME/parseIoStatOutput.log`. Please set environment variable `$LOG_HOME` to your preferred location. For instance, `export LOG_HOME=/home/logs`
